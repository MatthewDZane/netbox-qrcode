<!--Extend Netbox provided base webpage template and load resources-->
{% extends 'base.html' %} {% load render_table from django_tables2 %} 
{% block content %}

<h2 style="text-align: center">Netbox QR Code Menu</h2>

<!--OnClick callback for Reload QR Codes button-->
<script type="text/javascript">
  function reloadQR() {
    /* Perform GET requests and recieve json */
    var headers = {
      "Content-Type": "application/json",
      Accept: "application/json",
      Authorization: "Token cd664af77f6e41253025619a80be27a6a124f13e",
    }
    async function getRackJson() {
      return await fetch("https://netbox.nrp-nautilus.io/api/dcim/racks/", {
        headers: headers,
      }).then((response) => response.json())
    }

    async function getDeviceJson() {
      return await fetch("https://netbox.nrp-nautilus.io/api/dcim/devices/", {
        headers: headers,
      }).then((response) => response.json())
    }

    /* On valid racks and devices, create list of objects containing urls and ids */
    async function getURLS() {
      let urlList = []

      await getRackJson().then((json) => {
        const racks = json["results"]
        let url = "https://netbox.nrp-nautilus.io/dcim/racks/"
        racks.forEach((rack) => {
          const id = rack["id"]
          const url_id = [url, id, "/"].join("")
          urlList.push({ url_id, id })
        })
      })

      await getDeviceJson().then((json) => {
        const devices = json["results"]
        let url = "https://netbox.nrp-nautilus.io/dcim/devices/"
        devices.forEach((device) => {
          const id = device["id"]
          const url_id = [url, id, "/"].join("")
          urlList.push({ url_id, id })
        })
      })

      return urlList
    }

    /* Iterate through urls and open with unique identifier */
    getURLS().then((urls) => {
      let counter = 0
      urls.forEach((obj) => {
        window.open(obj.url_id, String(counter++))
      })
    })
  }
</script>

<!--Reload QR codes in container by opening new tabs of valid objects, needs popups enabled at web address-->
<div class="text-center">
  <button onclick="reloadQR()" ; class="btn btn-xl btn-primary">
    <span class="Submit" aria-hidden="true">Reload QR Codes</span>
  </button>
</div>

<!--Div to hold table and search components-->
<div class="row">
  <div class="col-md-12">
    <!--Div to hold all table components-->
    <div class="col-md-9">
      <!--POST form for checkbox submission-->
      <form method="POST" action="print/">
        {% csrf_token %}
        <h3>{% block title %}Devices{% endblock %}</h3>
        <!--Device Table-->
        <div class="row">
          <div>
            <!--Table variable from views.py-->
            {% render_table table_device %}

            <!--Print Button-->
            <div class="panel-footer text-left">
              <input
                class="btn btn-warning btn-sm"
                type="submit"
                value="Print Selected"
              />
              <span aria-hidden="true"></span>
            </div>
          </div>
        </div>

        <!--Specify object type-->
        <input type="hidden" name="obj_type" value="Devices" />
      </form>

      <!--POST form for checkbox submission-->
      <form method="POST" action="print/">
        {% csrf_token %}

        <!--Rack Table-->
        <h3>Racks</h3>
        <div class="row">
          <div>
            <!--Table variable from views.py-->
            {% render_table table_rack %}

            <!--Print Button-->
            <div class="panel-footer text-left">
              <input
                class="btn btn-warning btn-sm"
                type="submit"
                value="Print Selected"
              />
              <span aria-hidden="true"></span>
            </div>
          </div>
        </div>

        <!--Specify object type-->
        <input type="hidden" name="obj_type" value="Racks" />
      </form>

      <!--POST form for checkbox submission-->
      <form method="POST" action="print/">
        {% csrf_token %}

        <!--Cable Table-->
        <h3>Cables</h3>
        <div class="row">
          <div>
            <!--Table variable from views.py-->
            {% render_table table_cable %}

            <!--Print Button-->
            <div class="panel-footer text-left">
              <input
                class="btn btn-warning btn-sm"
                type="submit"
                value="Print Selected"
              />
              <span aria-hidden="true"></span>
            </div>
          </div>
        </div>

        <!--Specify object type-->
        <input type="hidden" name="obj_type" value="Cables" />
      </form>
    </div>

    <!--Filter Functionality-->
    <div class="col-md-3 pull-right right-side-panel noprint" style="padding-top: 50px">
      {% load form_helpers %}
      {% include 'inc/search_panel.html' %}
      <div style="padding-bottom: 100px"></div>
    </div>
  </div>
</div>

{% endblock %}
